{{- $ctx := . }}

{{- $attrs := .Attributes }}
{{- $code := .Inner  }}
{{- $lang := .Type  }}
{{- $opts := .Options }}
{{- $ordinal := .Ordinal }}
{{- $page := .Page }}
{{- $position := .Position }}

<pre>
$attrs    --> {{ $attrs }}
$opts     --> {{ $opts }}
$lang     --> {{ $lang }}
</pre>

{{- if eq (strings.ToLower $lang) "mermaid" }}
  <div class="mermaid">
    {{- $code | safeHTML }}
  </div>
  {{- .Page.Store.Set "hasMermaid" true }}
{{- else if transform.CanHighlight $lang }}
  {{- $result := transform.HighlightCodeBlock $ctx }}
  {{- $result.Wrapped }}
{{- else }}
  {{- if strings.HasPrefix (strings.ToLower $lang) "kroki" }}
    {{- $url := "https://kroki.io/" }}
    {{- $outputFormat := "svg" }}
    {{- $supportedTypes := slice
      "actdiag" "blockdiag" "bpmn" "bytefield" "ditaa" "erd" "graphviz" "mermaid"
      "nomnoml" "nwdiag" "packetdiag" "pikchr" "plantuml" "rackdiag" "seqdiag"
      "svgbob" "umlet" "vega" "vegalite" "wavedrom"
    }}
    {{- $typesDelimited := delimit $supportedTypes ", " ", and " }}
    {{- with $diagramType := index (split (strings.ToLower $lang) "-") 1 }}
      {{- if not (in $supportedTypes .) }}
        {{- errorf "The 'render-codeblock' template was called with an invalid 'Kroki' type %q. Valid types are %s. See %s" $typesDelimited $position }}
      {{- else }}
        {{- with $code }}
          {{- $kroki := dict
            "diagram_source" .
            "diagram_type" $diagramType
            "output_format" $outputFormat
          }}
          {{- $opts := dict
            "method" "post"
            "body" ($kroki | jsonify)
          }}
          {{- with resources.GetRemote $url $opts }}
            {{- with .Err }}
              {{- errorf "The %q shortcode was unable to get the remote diagram. Details: %s. See %s" $.Name . $position }}
            {{- else }}
              <div
                {{- range $k, $v := $attrs }}
                  {{- printf " %s=%q" $k $v | safeHTMLAttr }}
                {{- end -}}
              >
              {{- .Content | safeHTML }}
              </div>
            {{- end }}
          {{- else }}
            {{- errorf "The %q shortcode was unable to get the remote diagram. See %s" $.Name $position }}
          {{- end }}
        {{- else }}
          {{- errorf "The %q shortcode was called without content. See %s" $.Name $position }}
        {{- end }}
      {{- end }}
    {{- else }}
      {{- errorf "The %q shortcode requires a %q parameter. Valid types are %s. See %s" $.Name "type" $typesDelimited $position }}
    {{- end }}
  {{- end }}
{{- end -}}
